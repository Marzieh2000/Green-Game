<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Ø³Ù†Ø§Ø±ÛŒÙˆ Û² â€“ Ø¯ÛŒÙˆØ§Ø± Ø¢Ú¯Ø§Ù‡ÛŒ</title>

  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@500;600;700;800&display=swap" rel="stylesheet">
<script src="game-core.js"></script>
  <style>
    @font-face {
      font-family: "Yekan";
      src: local("Yekan"), local("IRYekan");
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: Yekan, sans-serif;
      background: url("background2.png") center/cover no-repeat fixed;
      color: #fff;
      overflow-x: hidden;
    }

    /* Ù‡Ø¯Ù Ø¯Ø§Ø±Øª */
    .target {
      position: absolute;
      top: 150px;
      left: 50%;
      transform: translateX(-50%);
      width: 420px;
      height: 420px;
      border-radius: 50%;
      background: radial-gradient(circle, #e53935 0 35%, #ffffff 35% 100%);
      box-shadow: 0 0 26px rgba(0,0,0,1), 0 0 50px rgba(0,0,0,0.85);
      transition: transform 0.1s;
      z-index: 5;
    }

    .target.shake { animation: targetShake 0.22s ease-out; }

    @keyframes targetShake {
      0%   { transform: translateX(-50%) translateX(0); }
      25%  { transform: translateX(-50%) translateX(-6px); }
      50%  { transform: translateX(-50%) translateX(6px); }
      75%  { transform: translateX(-50%) translateX(-3px); }
      100% { transform: translateX(-50%) translateX(0); }
    }

    /* Ø¯Ø§Ø±Øª */
    .dart {
      position: absolute;
      width: 70px;
      height: 70px;
      pointer-events: none;
      z-index: 8;
      top: 430px;
      left: calc(50% - 35px);
      animation: dartIdle 1.4s ease-in-out infinite alternate;
    }

    .dart::before {
      content: "";
      position: absolute;
      left: 30px;
      top: 14px;
      width: 8px;
      height: 34px;
      border-radius: 4px;
      background: linear-gradient(180deg,#ffca28,#f57c00);
      box-shadow: 0 0 6px rgba(0,0,0,0.8);
      transform: rotate(15deg);
    }

    .dart::after {
      content: "";
      position: absolute;
      left: 24px;
      top: 0;
      border-width: 0 10px 18px 10px;
      border-style: solid;
      border-color: transparent transparent #e53935 transparent;
      transform: rotate(15deg);
      filter: drop-shadow(0 0 4px rgba(0,0,0,0.8));
    }

    @keyframes dartIdle {
      from { transform: translateY(0) rotate(-4deg); }
      to   { transform: translateY(-5px) rotate(3deg); }
    }

    .dart.shooting {
      animation: none;
      transition: top 0.35s ease-out, left 0.35s ease-out;
    }

    /* Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ Ù¾Ø§ÛŒÛŒÙ† ØµÙØ­Ù‡ (Ø¨Ø²Ø±Ú¯â€ŒØªØ± Ø´Ø¯) */
    .cards-box {
      position: fixed;
      left: 0; right: 0;
      bottom: 0;
      padding: 18px 18px;
      background: rgba(0,0,0,0.82);
      backdrop-filter: blur(10px);
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
      justify-content: center;
      z-index: 40;
      border-top: 1px solid rgba(255,255,255,0.2);

      min-height: 100px;          /* Ø¨Ø²Ø±Ú¯â€ŒØªØ± */
      padding-bottom: 22px;
    }

    .card {
      width: 450px;               /* Ø¨Ø²Ø±Ú¯â€ŒØªØ± */
      max-width: 92vw;
      padding: 16px 16px;         /* Ø¨Ø²Ø±Ú¯â€ŒØªØ± */
      border-radius: 14px;
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.18);
      text-align: center;

      font-family: "Nunito", sans-serif;
      font-size: 22px;            /* ÙÙˆÙ†Øª Ø¨Ø²Ø±Ú¯â€ŒØªØ± */
      font-weight: 800;
      line-height: 1.9;

      cursor: pointer;
      transition: transform 0.18s ease, background 0.18s ease, box-shadow 0.18s ease, opacity 0.18s;
      box-shadow: 0 10px 22px rgba(0,0,0,0.75);
      color: #fff !important;
      user-select: none;
    }

    .card:hover {
      transform: translateY(-3px);
      background: rgba(255,255,255,0.16);
      box-shadow: 0 14px 28px rgba(0,0,0,0.90);
    }

    .card.disabled {
      opacity: 0.55;
      cursor: default;
      pointer-events: none;
    }

    /* Ù¾Ù†Ù„ Ø¢Ø±ÛŒØ§ */
    .aria-panel {
      position: fixed;
      right: 20px;
      top: 200px;
      width: min(510px, calc(100vw - 40px)); /* Ú©Ù…ÛŒ Ø¨Ø²Ø±Ú¯â€ŒØªØ± */
      background: rgba(0,0,0,0.7);
      border-radius: 16px;
      padding: 12px 14px;
      display: flex;
      align-items: flex-start;
      gap: 10px;
      z-index: 30;
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 24px rgba(0,0,0,0.85);
    }

    .aria-avatar {
      width: 46px;
      height: 46px;
      border-radius: 50%;
      overflow: hidden;
      box-shadow: 0 0 10px rgba(0,0,0,0.8);
      flex-shrink: 0;
    }

    .aria-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
    }

    .aria-content { flex: 1; }

    .aria-name {
      font-size: 12px;
      opacity: 0.9;
      color: #b8ff7d;
      margin-bottom: 6px;
      font-family: "Nunito", sans-serif;
      font-weight: 800;
    }

    /* Ù…ØªÙ† Ø¯Ø§Ø®Ù„ Ø¨Ø§Ú©Ø³ Ø¢Ø±ÛŒØ§ â€“ Ø¯Ø±Ø´Øªâ€ŒØªØ± Ùˆ Ø®ÙˆØ§Ù†Ø§ØªØ± */
.aria-text {
  font-family: "Nunito", sans-serif;
  font-size: 20px;
  font-weight: 700;
  line-height: 1.9;
  color: #ffffff;
}

    .aria-text span.good { color: #b8ff7d; }
    .aria-text span.bad  { color: #ffb5b5; }

    /* Ù¾Ù†Ø¬Ø±Ù‡ Ù¾Ø§ÛŒØ§Ù† */
    .end-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.75);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .end-modal {
      background: rgba(0,0,0,0.9);
      border-radius: 18px;
      padding: 18px 22px;
      width: min(420px, 92vw);
      backdrop-filter: blur(16px);
      box-shadow: 0 22px 40px rgba(0,0,0,1);
      text-align: center;
      color: #fff;
    }

    .end-title { font-size: 18px; margin-bottom: 8px; font-family: "Nunito", sans-serif; font-weight: 900; }
    .end-text  { font-size: 15px; line-height: 1.9; margin-bottom: 16px; opacity: 0.98; font-family: "Nunito", sans-serif; font-weight: 700; }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 10px 16px;
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 12px 22px rgba(0,0,0,0.9);
      transition: transform 0.18s ease, box-shadow 0.18s ease, background 0.18s ease;
      margin: 0 6px;
      font-family: "Nunito", sans-serif;
      font-weight: 800;
    }
    .btn-primary { background: linear-gradient(135deg,#b8ff6a,#46ff8f); color: #072313; }
    .btn-secondary { background: rgba(255,255,255,0.06); color: #fff; }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 16px 28px rgba(0,0,0,1); }
    .btn:active { transform: translateY(1px); box-shadow: 0 7px 14px rgba(0,0,0,0.85); }

    /* Ø³ØªØ§Ø±Ù‡â€ŒÙ‡Ø§: ÙÙ‚Ø· Û³ ØªØ§ */
    .stars-box {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 10px;
      z-index: 20;
    }

    .star {
      width: 30px;
      height: 30px;
      background: url("star-off.png") center/contain no-repeat;
      opacity: 0.45;
      transition: opacity 0.25s, transform 0.25s;
    }

    .star.active {
      background: url("star-on.png") center/contain no-repeat;
      opacity: 1;
      transform: scale(1.18);
      filter: drop-shadow(0 0 6px #ffeb3b);
    }

    /* ØªØ§ÛŒÙ…Ø± Ù…Ø±Ø¬Ø¹ */
    .timer-box {
      position: fixed;
      top: 20px;
      left: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 20px;
      background: rgba(2,6,23,0.80);
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,0.18);
      box-shadow: 0 8px 30px rgba(0,0,0,0.65);
      z-index: 40;
      backdrop-filter: blur(8px);
    }

    .hourglass {
      font-size: 34px;
      animation: flip 2s infinite linear;
    }

    .time-text {
      font-family: "Nunito", sans-serif;
      font-size: 34px;
      font-weight: 800;
      letter-spacing: 1px;
      color: #fff;
    }

    .timer-warning .time-text { color: #ef4444; }

    @keyframes flip {
      0%   { transform: rotate(0deg); }
      50%  { transform: rotate(180deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 700px) {
      .card { width: 92vw; font-size: 20px; }
      .cards-box { min-height: 180px; }
      .aria-panel { right: 10px; width: calc(100vw - 20px); }
    }
     .top-bar {
    padding: 14px 24px 4px;
    font-size: 22px;
    font-weight: bold;
    text-align: center;
     color: #020617
  }
  </style>
</head>

<body>
  <div class="top-bar"> Ú©Ø§Ù‡Ø´ Ù¾Ø³Ù…Ø§Ù†Ø¯</div>
  <!-- Ø³ØªØ§Ø±Ù‡â€ŒÙ‡Ø§: ÙÙ‚Ø· Û³ Ø¹Ø¯Ø¯ -->
  <div class="stars-box" id="starsBox">
    <div class="star"></div>
    <div class="star"></div>
    <div class="star"></div>
  </div>

  <!-- ØªØ§ÛŒÙ…Ø± -->
  <div class="timer-box" id="timerBox">
    <span class="hourglass">â³</span>
    <span class="time-text" id="timeText">01:00</span>
  </div>

  <!-- Ù‡Ø¯Ù Ùˆ Ø¯Ø§Ø±Øª -->
  <div class="target" id="target"></div>
  <div class="dart" id="dart"></div>

  <!-- Ù¾Ù†Ù„ Ø¢Ø±ÛŒØ§ -->
  <div class="aria-panel">
    <div class="aria-avatar">
      <img src="aria.png" alt="Ø¢Ø±ÛŒØ§">
    </div>
    <div class="aria-content">
      <div class="aria-name">Ø¢Ø±ÛŒØ§ â€“ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ù¾Ø±Ø¯ÛŒØ³ Ø³Ø¨Ø²</div>
      <div class="aria-text" id="ariaText">
        <span class="good"></span> 3 Ø¬Ù…Ù„Ù‡ Ø¯Ø±Ø³Øª Ø¯Ø±Ù…ÙˆØ±Ø¯ Ú©Ø§Ù‡Ø´ Ù¾Ø³Ù…Ø§Ù†Ø¯ Ø±Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†
       
      </div>
    </div>
  </div>

  <!-- Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ -->
  <div class="cards-box" id="cardsBox"></div>

  <!-- Ù¾Ù†Ø¬Ø±Ù‡ Ù¾Ø§ÛŒØ§Ù† -->
<!-- Ù¾Ù†Ø¬Ø±Ù‡ Ù¾Ø§ÛŒØ§Ù† -->
<div class="end-backdrop" id="endBackdrop">
  <div class="end-modal">
    <div class="end-title" id="endTitle">Ù¾Ø§ÛŒØ§Ù†</div>
    <div class="end-text" id="endText"></div>
    <button class="btn btn-primary" id="btnNext">Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø¹Ø¯ÛŒ</button>
  </div>
</div>


<script>
  /* =========================
     ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…Ø±Ø­Ù„Ù‡
  ========================= */
  const TARGET_SCORE = 3;
  const GAME_SECONDS = 60;
  const HAND_SIZE = 3;     // Ù‡Ù…ÛŒØ´Ù‡ Û³ Ú©Ø§Ø±Øª Ø±ÙˆÛŒ ØµÙØ­Ù‡

  /* =========================
     Web Audio
  ========================= */
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

  function playCorrect() {
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = "sine";
    o.frequency.setValueAtTime(500, audioCtx.currentTime);
    o.frequency.exponentialRampToValueAtTime(1300, audioCtx.currentTime + 0.18);
    g.gain.setValueAtTime(0.35, audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.22);
    o.connect(g).connect(audioCtx.destination);
    o.start();
    o.stop(audioCtx.currentTime + 0.22);
  }

  function playWrong() {
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = "sawtooth";
    o.frequency.setValueAtTime(200, audioCtx.currentTime);
    g.gain.setValueAtTime(0.35, audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.25);
    o.connect(g).connect(audioCtx.destination);
    o.start();
    o.stop(audioCtx.currentTime + 0.25);
  }

  function playHit() {
    const noise = audioCtx.createBufferSource();
    const buffer = audioCtx.createBuffer(1, audioCtx.sampleRate * 0.06, audioCtx.sampleRate);
    const data = buffer.getChannelData(0);
    for (let i = 0; i < data.length; i++) data[i] = (Math.random() * 2 - 1) * (1 - i / data.length);
    noise.buffer = buffer;
    noise.connect(audioCtx.destination);
    noise.start();
  }

  /* =========================
     Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
  ========================= */
  const allItems = [
    { text:"Ù†ÙˆØ´ÛŒØ¯Ù† Ø¢Ø¨ Ø¨Ø·Ø±ÛŒ Ø¨Ø§Ø¹Ø« Ø§ÙØ²Ø§ÛŒØ´ ØªÙˆÙ„ÛŒØ¯ Ø²Ø¨Ø§Ù„Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.", correct:true },
    { text:"Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù„ÛŒÙˆØ§Ù†â€ŒÙ‡Ø§ÛŒ Ù‚Ø§Ø¨Ù„ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…Ø¬Ø¯Ø¯ØŒ ØªÙˆÙ„ÛŒØ¯ Ø²Ø¨Ø§Ù„Ù‡ Ø±Ø§ Ú©Ø§Ù‡Ø´ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯.", correct:true },
    { text:"Ø®Ø´Ú© Ú©Ø±Ø¯Ù† Ø¯Ø³Øªâ€ŒÙ‡Ø§ Ø¨Ø§ Ø¯Ø³ØªÙ…Ø§Ù„ Ú©Ø§ØºØ°ÛŒ ØªÙˆÙ„ÛŒØ¯ Ø²Ø¨Ø§Ù„Ù‡ Ø±Ø§ Ø§ÙØ²Ø§ÛŒØ´ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯.", correct:true },

    { text:"Ø¨Ø·Ø±ÛŒâ€ŒÙ‡Ø§ÛŒ Ù¾Ù„Ø§Ø³ØªÛŒÚ©ÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ø­ÛŒØ· Ø²ÛŒØ³Øª Ø¨Ù‡ØªØ± Ø§Ø² Ø¨Ø·Ø±ÛŒâ€ŒÙ‡Ø§ÛŒ Ø´ÛŒØ´Ù‡â€ŒØ§ÛŒ Ù‡Ø³ØªÙ†Ø¯.", correct:false },
    { text:"Ø²Ø¨Ø§Ù„Ù‡â€ŒÙ‡Ø§ÛŒ Ø±ÙˆÛŒ Ø²Ù…ÛŒÙ† Ù†Ø§Ø´ÛŒ Ø§Ø² Ú©Ù…Ø¨ÙˆØ¯ Ø³Ø·Ù„â€ŒØ²Ø¨Ø§Ù„Ù‡ Ù‡Ø³ØªÙ†Ø¯.", correct:false },
    { text:"Ø²Ø¨Ø§Ù„Ù‡â€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ø¨Ø§Ø²ÛŒØ§ÙØª Ø´ÙˆÙ†Ø¯ØŒ Ø¢Ù„ÙˆØ¯Ú¯ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ù†Ø¯.", correct:false },
    { text:"Ø¢ÙˆØ±Ø¯Ù† Ù†Ø§Ù‡Ø§Ø± Ø§Ø² Ø®Ø§Ù†Ù‡ Ø¨Ø§Ø¹Ø« Ø§ÙØ²Ø§ÛŒØ´ ØªÙˆÙ„ÛŒØ¯ Ø²Ø¨Ø§Ù„Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯", correct:false },
    { text:"ØªÙ‡â€ŒØ³ÛŒÚ¯Ø§Ø±Ù‡Ø§ Ù‚Ø§Ø¨Ù„ ØªØ¬Ø²ÛŒÙ‡ Ù‡Ø³ØªÙ†Ø¯.", correct:false },
  ];

  function shuffle(arr) {
    const a = arr.slice();
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  /* =========================
     DOM
  ========================= */
  const cardsBox    = document.getElementById("cardsBox");
  const ariaText    = document.getElementById("ariaText");
  const dart        = document.getElementById("dart");
  const target      = document.getElementById("target");

  const timerBox    = document.getElementById("timerBox");
  const timeText    = document.getElementById("timeText");

  const endBackdrop = document.getElementById("endBackdrop");
  const endTitle    = document.getElementById("endTitle");
  const endText     = document.getElementById("endText");
const btnNext = document.getElementById("btnNext");


  const stars = Array.from(document.querySelectorAll(".star"));

  /* =========================
     ÙˆØ¶Ø¹ÛŒØª Ø¨Ø§Ø²ÛŒ
  ========================= */
  let score = 0;
  let gameEnded = false;
  let isAnimating = false;

  // Ø§ÛŒÙ† Ø¯Ùˆ ØªØ§ Ù…Ø®Ø²Ù† Ø¬Ø¯Ø§ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ ØªØ§ Ù‡Ù…ÛŒØ´Ù‡ Ø¨ØªÙˆØ§Ù†ÛŒÙ… ØªØ¶Ù…ÛŒÙ† Ø¯Ø±Ø³Øª Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒÙ…
  let correctPool = [];
  let wrongPool = [];

  // Ø¯Ø³ØªÛŒ Ú©Ù‡ Ø±ÙˆÛŒ ØµÙØ­Ù‡ Ù†Ù…Ø§ÛŒØ´ Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ…
  let hand = []; // [{text, correct}, ...]

  /* =========================
     ØªØ§ÛŒÙ…Ø±
  ========================= */
  let timeLeft = GAME_SECONDS;
  let timerInterval = null;

  function updateTimerUI() {
    const m = String(Math.floor(timeLeft / 60)).padStart(2, "0");
    const s = String(timeLeft % 60).padStart(2, "0");
    timeText.textContent = `${m}:${s}`;
  }

  function startTimer() {
    clearInterval(timerInterval);
    timeLeft = GAME_SECONDS;
    timerBox.classList.remove("timer-warning");
    updateTimerUI();

    timerInterval = setInterval(() => {
      if (gameEnded) {
        clearInterval(timerInterval);
        return;
      }
      timeLeft--;
      updateTimerUI();

      if (timeLeft <= 10) timerBox.classList.add("timer-warning");
      if (timeLeft <= 0) endGame(false);
    }, 1000);
  }

  /* =========================
     Ø³ØªØ§Ø±Ù‡ + Ø§Ù…ØªÛŒØ§Ø² (ÙÙ‚Ø· Ø¯Ø±Ø³Øª)
  ========================= */
  function activateStar() {
    if (score >= stars.length) return;
    stars[score].classList.add("active");
    score++;
    if (score >= TARGET_SCORE) endGame(true);
  }

  /* =========================
     Ø´Ù„ÛŒÚ© Ø¯Ø§Ø±Øª
  ========================= */
  function shootDart(isCorrect) {
    const tRect = target.getBoundingClientRect();
    const dRect = dart.getBoundingClientRect();

    const startX = tRect.left + tRect.width / 2 - dRect.width / 2;
    const startY = tRect.bottom + 40;

    dart.classList.remove("shooting");
    dart.style.transition = "none";
    dart.style.left = startX + "px";
    dart.style.top  = startY + "px";
    void dart.offsetWidth;

    dart.classList.add("shooting");
    dart.style.transition = "top 0.35s ease-out, left 0.35s ease-out";

    let targetX, targetY;

    if (isCorrect) {
      targetX = tRect.left + tRect.width / 2 - dRect.width / 2;
      targetY = tRect.top + tRect.height / 2 - dRect.height * 0.7;
    } else {
      const r = tRect.width * 0.45;
      const centerX = tRect.left + tRect.width / 2;
      const centerY = tRect.top + tRect.height / 2;
      const angles = [30,60,120,150,210,240,300,330];
      const angleDeg = angles[Math.floor(Math.random()*angles.length)];
      const angleRad = angleDeg * Math.PI / 180;
      const hitX = centerX + r * Math.cos(angleRad);
      const hitY = centerY + r * Math.sin(angleRad);
      targetX = hitX - dRect.width / 2;
      targetY = hitY - dRect.height / 2;
    }

    dart.style.left = targetX + "px";
    dart.style.top  = targetY + "px";

    setTimeout(() => {
      target.classList.add("shake");
      playHit();
      setTimeout(() => target.classList.remove("shake"), 230);
    }, 260);
  }

  /* ============================================================
     Ù…Ù†Ø·Ù‚ ØªØ¶Ù…ÛŒÙ†: Ù‡Ù…ÛŒØ´Ù‡ Ø­Ø¯Ø§Ù‚Ù„ Û± Ø¯Ø±Ø³Øª Ø¯Ø§Ø®Ù„ Û³ Ú©Ø§Ø±Øª
  ============================================================ */
  function buildSmartPool() {
    const shuffled = shuffle(allItems);
    correctPool = shuffled.filter(x => x.correct);
    wrongPool   = shuffled.filter(x => !x.correct);
  }

  function takeOneFrom(poolArr) {
    // Ø§Ú¯Ø± ØªÙ‡ Ú©Ø´ÛŒØ¯ØŒ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ø² Ù‡Ù…Ø§Ù† Ø¯Ø³ØªÙ‡ shuffle Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… (Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ú¯ÛŒØ± Ù†Ú©Ù†Ø¯)
    if (poolArr.length === 0) return null;
    return poolArr.pop();
  }

  function refillIfEmpty() {
    // Ø§Ú¯Ø± Ù‡Ø± Ú©Ø¯Ø§Ù… Ø®Ø§Ù„ÛŒ Ø´Ø¯ØŒ Ø§Ø² Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ù…ÛŒâ€ŒØ³Ø§Ø²ÛŒÙ… (Ø§Ù…Ø§ Ø¨Ø¯ÙˆÙ† Ø¨Ù‡Ù… Ø±ÛŒØ®ØªÙ† progress Ø³ØªØ§Ø±Ù‡â€ŒÙ‡Ø§)
    if (correctPool.length === 0 || wrongPool.length === 0) {
      // Ø¨Ø§Ø²Ø³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„ØŒ ÙˆÙ„ÛŒ Ø¯Ù‚Øª Ú©Ù†: Ø¯Ø±Ø³Øªâ€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ù‚Ø¨Ù„Ø§Ù‹ Ú¯Ø±ÙØªÙ‡ Ø´Ø¯Ù‡ Ù…Ù‡Ù… Ù†ÛŒØ³ØªØŒ Ú†ÙˆÙ† Ø¨Ø±Ø¯ Ø¨Ø§ Ø³ØªØ§Ø±Ù‡â€ŒÙ‡Ø§Ø³Øª.
      buildSmartPool();
    }
  }

  function drawSmartHand() {
    // Ù‡Ø¯Ù: hand Ø¨Ø§ Ø§Ù†Ø¯Ø§Ø²Ù‡ HAND_SIZE Ùˆ Ø­Ø¯Ø§Ù‚Ù„ Û± Ú©Ø§Ø±Øª correct

    refillIfEmpty();

    const newHand = [];

    // 1) Ø§ÙˆÙ„ Ø­ØªÙ…Ø§Ù‹ ÛŒÚ© Ú©Ø§Ø±Øª Ø¯Ø±Ø³Øª Ù…ÛŒâ€ŒÚ¯Ø°Ø§Ø±ÛŒÙ… (ØªØ§ ØªØ¶Ù…ÛŒÙ† Ø´ÙˆØ¯)
    let c = takeOneFrom(correctPool);
    if (!c) {
      // Ø§Ú¯Ø± Ø¨Ù‡ Ù‡Ø± Ø¯Ù„ÛŒÙ„ÛŒ Ù†Ø¨ÙˆØ¯ØŒ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¨Ø³Ø§Ø²
      buildSmartPool();
      c = takeOneFrom(correctPool);
    }
    if (c) newHand.push(c);

    // 2) Ø¨Ù‚ÛŒÙ‡ Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ Ø±Ø§ Ø§Ø² ØªØ±Ú©ÛŒØ¨ ØºÙ„Ø·/Ø¯Ø±Ø³Øª Ù¾Ø± Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
    while (newHand.length < HAND_SIZE) {
      // ÙˆØ²Ù† Ø¯Ø§Ø¯Ù†: Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ ØºÙ„Ø· Ø¨ÛŒØ´ØªØ± Ø¨Ø§Ø´Ø¯ Ø¨Ø±Ø§ÛŒ Ú†Ø§Ù„Ø´
      const pickWrong = Math.random() < 0.70;

      let item = null;
      if (pickWrong) item = takeOneFrom(wrongPool) || takeOneFrom(correctPool);
      else item = takeOneFrom(correctPool) || takeOneFrom(wrongPool);

      if (!item) {
        buildSmartPool();
        continue;
      }

      // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² ØªÚ©Ø±Ø§Ø± Ù…ØªÙ† Ø¯Ø± Ù‡Ù…Ø§Ù† Ø¯Ø³Øª
      if (newHand.some(x => x.text === item.text)) continue;

      newHand.push(item);
    }

    // 3) Ø¯Ø³Øª Ø±Ø§ shuffle Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ú©Ù‡ Ø¯Ø±Ø³Øª Ù‡Ù…ÛŒØ´Ù‡ Ø¬Ø§ÛŒ Ø«Ø§Ø¨Øª Ù†Ø¨Ø§Ø´Ø¯
    return shuffle(newHand);
  }

  function renderHand() {
    cardsBox.innerHTML = "";
    hand.forEach((item) => {
      const c = document.createElement("div");
      c.className = "card";
      c.textContent = item.text;
      c.dataset.correct = item.correct ? "true" : "false";
      cardsBox.appendChild(c);
    });
  }
function saveFinalScore() {
  // Ø§Ù…ØªÛŒØ§Ø² ØªØ¬Ù…Ø¹ÛŒ Ú©Ù„ Ø¨Ø§Ø²ÛŒ
  const prevTotal = parseInt(localStorage.getItem("totalScore") || "0", 10);
  localStorage.setItem("totalScore", String(prevTotal + score));

  // Ø§Ù…ØªÛŒØ§Ø² Ù‡Ù…ÛŒÙ† Ù…Ø±Ø­Ù„Ù‡
  localStorage.setItem("stage2Score", String(score));
}
  /* =========================
     Ù¾Ø§ÛŒØ§Ù† Ø¨Ø§Ø²ÛŒ
  ========================= */
function endGame(won) {
  if (gameEnded) return;
  gameEnded = true;

  clearInterval(timerInterval);

  // â­ Ø°Ø®ÛŒØ±Ù‡ Ø§Ù…ØªÛŒØ§Ø² Ù†Ù‡Ø§ÛŒÛŒ
  saveFinalScore();

  if (won) {
    endTitle.textContent = "Ø¢ÙØ±ÛŒÙ†! â­";
    endText.innerHTML = `
      ØªÙˆ Û³ Ø¬Ù…Ù„Ù‡ Ø¯Ø±Ø³Øª Ø±Ø§ Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯ÛŒ Ùˆ Ù…Ø±Ø­Ù„Ù‡ Ø±Ø§ Ú©Ø§Ù…Ù„ Ú©Ø±Ø¯ÛŒ ğŸ‰<br>
      Ø§Ù…ØªÛŒØ§Ø² Ø§ÛŒÙ† Ù…Ø±Ø­Ù„Ù‡: <b>${score}</b> Ø§Ø² 3<br>
      Ø§Ù…ØªÛŒØ§Ø² Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ âœ…
    `;
  } else {
    endTitle.textContent = "Ø²Ù…Ø§Ù† ØªÙ…Ø§Ù… Ø´Ø¯ â³";
    endText.innerHTML = `
      Ø²Ù…Ø§Ù† Ù…Ø±Ø­Ù„Ù‡ Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯.<br>
      Ø§Ù…ØªÛŒØ§Ø² Ø§ÛŒÙ† Ù…Ø±Ø­Ù„Ù‡: <b>${score}</b> Ø§Ø² 3<br>
      Ø§Ù…ØªÛŒØ§Ø² Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ âœ…
    `;
  }

  endBackdrop.style.display = "flex";
}

  /* =========================
     Ú©Ù„ÛŒÚ© Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§
  ========================= */
  cardsBox.addEventListener("click", (e) => {
    if (gameEnded || isAnimating) return;

    const cardEl = e.target.closest(".card");
    if (!cardEl) return;

    isAnimating = true;

    if (audioCtx.state === "suspended") {
      audioCtx.resume().catch(()=>{});
    }

    const isCorrect = cardEl.dataset.correct === "true";

    if (isCorrect) {
      cardEl.classList.add("disabled");
      cardEl.style.background = "rgba(120,255,160,0.40)";
      ariaText.innerHTML = `<span class="good">Ø¢ÙØ±ÛŒÙ†!</span> Ø§ÛŒÙ† Ø¬Ù…Ù„Ù‡ Ø¯Ø±Ø³Øª Ø§Ø³Øª.`;

      playCorrect();
      shootDart(true);
      activateStar();

      // Ø­Ø°Ù Ú©Ø§Ø±Øª Ø¯Ø±Ø³Øª Ø§Ø² hand Ùˆ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ Ø¨Ø§ ÛŒÚ© Ú©Ø§Ø±Øª Ø¬Ø¯ÛŒØ¯ØŒ Ø§Ù…Ø§ ØªØ¶Ù…ÛŒÙ† Ø¯Ø±Ø³Øª Ø¨Ø±Ù‚Ø±Ø§Ø± Ø¨Ù…Ø§Ù†Ø¯
      setTimeout(() => {
        // 1) Ú©Ø§Ø±Øª Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ Ø±Ø§ Ø§Ø² hand Ø­Ø°Ù Ú©Ù†
        const text = cardEl.textContent;
        hand = hand.filter(x => x.text !== text);

        // 2) Ø§Ú¯Ø± Ø¨Ø§Ø²ÛŒ ØªÙ…Ø§Ù… Ù†Ø´Ø¯Ù‡ØŒ hand Ø±Ø§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ù¾Ø± Ú©Ù† (Û³ØªØ§ÛŒÛŒ Ùˆ ØªØ¶Ù…ÛŒÙ† Ø¯Ø±Ø³Øª)
        if (!gameEnded) {
          // Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ú¯ÛŒØ±: Ø§Ú¯Ø± Ø§Ù„Ø§Ù† Ù‡ÛŒÚ† Ø¯Ø±Ø³Øª Ø¯Ø§Ø®Ù„ hand Ù†Ø¨ÙˆØ¯ØŒ Ø¯Ø³Øª Ø±Ø§ Ø§Ø² Ù†Ùˆ Ù…ÛŒâ€ŒØ³Ø§Ø²ÛŒÙ…
          const hasCorrect = hand.some(x => x.correct);
          if (!hasCorrect) {
            hand = drawSmartHand();
          } else {
            // ÙÙ‚Ø· ÛŒÚ© Ø¢ÛŒØªÙ… Ø§Ø¶Ø§ÙÙ‡ Ú©Ù† Ùˆ Ø¨Ø¹Ø¯ shuffle Ú©Ù†
            refillIfEmpty();
            let added = null;
            // Ø³Ø¹ÛŒ Ú©Ù† Ø¢ÛŒØªÙ… ØªÚ©Ø±Ø§Ø±ÛŒ Ù†Ø¯Ù‡
            for (let tries = 0; tries < 20; tries++) {
              const pickWrong = Math.random() < 0.70;
              const cand = pickWrong ? (takeOneFrom(wrongPool) || takeOneFrom(correctPool))
                                     : (takeOneFrom(correctPool) || takeOneFrom(wrongPool));
              if (!cand) { buildSmartPool(); continue; }
              if (hand.some(x => x.text === cand.text)) continue;
              added = cand;
              break;
            }
            if (added) hand.push(added);
            hand = shuffle(hand);
          }
          renderHand();
        }

        isAnimating = false;
      }, 420);

    } else {
      cardEl.style.background = "rgba(255,120,120,0.45)";
      ariaText.innerHTML = `<span class="bad">Ø§ÛŒÙ† ÛŒÚ©ÛŒ Ø¯Ø±Ø³Øª Ù†Ø¨ÙˆØ¯.</span> `;

      playWrong();
      shootDart(false);

      setTimeout(() => {
        isAnimating = false;
      }, 420);
    }
  });

  /* =========================
     Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ
  ========================= */
  function initGame() {
    gameEnded = false;
    isAnimating = false;
    score = 0;

    stars.forEach(s => s.classList.remove("active"));

    buildSmartPool();
    hand = drawSmartHand();
    renderHand();

    startTimer();
  }

  btnNext.addEventListener("click", () => {
  // Ø¢Ø¯Ø±Ø³ Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø¹Ø¯ÛŒ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†
  window.location.href = "stage1-3.html";
});


  initGame();
</script>

</body>
</html>
