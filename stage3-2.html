<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>پنل عملکرد – شبکه فاضلاب سبز</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@600;700;800&display=swap" rel="stylesheet">
  <script src="game-core.js"></script>
  <style>
    *{box-sizing:border-box}
   body{
  margin:0;
  font-family:"Nunito", sans-serif;
  background:#061018 url("letter1.png") center/cover no-repeat fixed;
  color:#fff;
  background-size: 130% auto;
  overflow:hidden;
  position: relative;
   isolation: isolate;   
}
body::after{
  content:"";
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.85);
  z-index: -1;          /* ✅ پشت کل محتوا */
  pointer-events: none;
}



  .hud{
  position:fixed;
  inset:0;
  display:block;
  pointer-events:none;
}
.panel{
  width:100vw;
  height:100vh;
  border-radius:0;
  background:transparent;
  border:none;
  backdrop-filter:none;
  box-shadow:none;
  overflow:hidden;
  position:relative;
  pointer-events:auto;
}

   /* ===== چیدمان سوال‌ها: دو ستون با فاصله کاملاً یکسان ===== */
.q-wrap{
  position:absolute;
  top:90px;
  left:40px;
  right:40px;
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:18px 56px;              /* فاصله عمودی / فاصله بین دو ستون */
  z-index:40;
  pointer-events:none;
}

/* هر ردیف شامل باکس + شیر */
.q-row{
  display:flex;
  align-items:center;
  gap:10px;
  pointer-events:none;
}

/* ستون راست: باکس -> شیر (شیر در انتهای باکس سمت چپش) */
.q-row.right{ justify-content:flex-end; }

/* ستون چپ: شیر -> باکس (شیر در انتهای باکس سمت راستش) */
.q-row.left{ justify-content:flex-start; }

/* باکس متن */
.q-label{
  position:relative;
  width:min(520px, 46vw);
  font-weight:900;
  font-size:18px;
  line-height:1.85;
  color:#eafff2;
  padding:14px 16px;
  border-radius:16px;
  background:rgba(0,0,0,0.55);
  border:1px solid rgba(255,255,255,.12);
  text-shadow:0 10px 24px rgba(0,0,0,.85);
  user-select:none;
  pointer-events:none;
  backdrop-filter: blur(2px);
}

/* شیر HTML (روی متن نیست، کنار متن است) */
.valve-ui{
  width:44px;
  height:44px;
  border-radius:999px;
  border:2px solid rgba(255,255,255,.25);
  background:rgba(0,0,0,.35);
  display:grid;
  place-items:center;
  filter: drop-shadow(0 12px 22px rgba(0,0,0,.45));
  pointer-events:auto;        /* کلیک‌پذیر */
  cursor:pointer;
  position:relative;
}

.valve-ui::before{
  content:"";
  width:26px;
  height:4px;
  background:rgba(255,255,255,.85);
  border-radius:999px;
  position:absolute;
}

.valve-bar{
  width:4px;
  height:28px;
  background:rgba(120,255,190,.85);
  border-radius:999px;
  transform-origin:center;
  transform:rotate(-70deg);
}

.valve-mini{
  position:absolute;
  bottom:52px;                 /* ✅ بالای شیر */
  left:50%;
  transform:translateX(-50%);
  font-size:16px;              /* ✅ بزرگ‌تر */
  font-weight:900;
  color:#eafff2;
  opacity:1;
  white-space:nowrap;
  pointer-events:none;
  text-shadow:0 10px 20px rgba(0,0,0,.8);
  padding:4px 8px;
  border-radius:999px;
  background:rgba(0,0,0,.35);
  border:1px solid rgba(255,255,255,.12);
}


    /* راهنما */
    .hint{
      position:absolute;
      top:14px;
      left:14px;
      right:14px;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      padding:10px 14px;
      border-radius:16px;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.10);
      z-index:10;
    }
    .hint b{font-size:14px}
    .meter{
      display:flex; align-items:center; gap:10px;
      font-weight:900;
    }
    .pill{
      padding:6px 10px;
      border-radius:999px;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.12);
      font-size:12px;
      opacity:.95;
    }
    .btn{
      border:none;
      cursor:pointer;
      font-weight:900;
      padding:10px 14px;
      border-radius:999px;
      color:#062114;
      background:linear-gradient(135deg,#b8ff6a,#46ff8f);
      box-shadow:0 14px 30px rgba(0,0,0,.45);
    }

    /* SVG روی پنل */
    svg{ width:100%; height:100%; display:block; }

    /* شیرها */
    .valve-hit{
      cursor:pointer;
      pointer-events:auto;
    }
    .valve-text{
      font-size:20px;
      font-weight:900;
      fill:#eafff2;
      opacity:.95;
    }
    .valve-state{
      font-size:20px;
      font-weight:800;
      fill:#c7ffe2;
      opacity:.9;
    }
/* ===== Pipe Label (باکس شبیه لوله فاضلاب) ===== */
.q-label{
  position:relative;
  width:min(520px, 46vw);
  padding:16px 18px;
  border-radius:18px;

  /* بدنه لوله: گرادیان چندلایه */
  background:
    linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,0) 35%),
    linear-gradient(90deg, rgba(18,26,30,.95), rgba(46,60,68,.92) 45%, rgba(20,28,34,.95));
  
  border:1px solid rgba(255,255,255,.14);
  box-shadow:
    inset 0 10px 18px rgba(255,255,255,.08),
    inset 0 -14px 22px rgba(0,0,0,.35),
    0 16px 34px rgba(0,0,0,.55);

  text-shadow:0 10px 24px rgba(0,0,0,.85);
  color:#eafff2;

  /* حس قطعه صنعتی */
  letter-spacing:.1px;
  user-select:none;
}

/* درز/جوش روی بدنه */
.q-label::after{
  content:"";
  position:absolute;
  inset:10px 18px 10px 18px;
  border-radius:14px;
  border:1px dashed rgba(255,255,255,.10);
  opacity:.55;
  pointer-events:none;
}

/* دهانه لوله (Socket / Coupling) */
.q-label::before{
  content:"";
  position:absolute;
  top:50%;
  transform:translateY(-50%);
  width:44px;
  height:calc(100% + 10px);
  border-radius:18px;

  background:
    linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,0) 40%),
    linear-gradient(90deg, rgba(70,90,98,.95), rgba(18,26,30,.95));
  
  box-shadow:
    inset 0 10px 18px rgba(255,255,255,.10),
    inset 0 -12px 18px rgba(0,0,0,.35),
    0 10px 22px rgba(0,0,0,.45);

  border:1px solid rgba(255,255,255,.16);
  pointer-events:none;
  opacity:.98;
}

/* رینگ داخلی دهانه (برای عمق) */
.q-label .pipe-ring{ display:none; } /* فقط برای سازگاری اگر چیزی اضافه شد */
/* دهانه برای ستون راست: بیرون = سمت راست */
.q-row.right .q-label::before{
  right:-18px;
}

/* دهانه برای ستون چپ: بیرون = سمت چپ */
.q-row.left .q-label::before{
  left:-18px;
}
/* نازل اتصال داخلی */
.q-row.right .q-label{
  padding-right:26px;
}
.q-row.left .q-label{
  padding-left:26px;
}

.q-row.right .q-label .pipe-nozzle,
.q-row.left  .q-label .pipe-nozzle{ display:none; }

/* نازل با pseudo-element اضافه */
.q-row.right .q-label{
  --noz: -14px;
}
.q-row.left .q-label{
  --noz: -14px;
}

.q-row.right .q-label{
  box-shadow:
    inset 0 10px 18px rgba(255,255,255,.08),
    inset 0 -14px 22px rgba(0,0,0,.35),
    0 16px 34px rgba(0,0,0,.55);
}

.q-row.right .q-label{
  /* nothing here, nozzle is made below */
}

.q-row.right .q-label span,
.q-row.left .q-label span{ position:relative; z-index:2; }

/* نازل داخلی (سمت مخزن) */
.q-row.right .q-label{
  /* برای right: سمت چپ داخلی */
}
.q-row.left .q-label{
  /* برای left: سمت راست داخلی */
}

.q-row.right .q-label::marker{ content:""; } /* ignore */

.q-row.right .q-label{
  /* نازل داخلی با after دوم ممکن نیست، پس از box-shadow و gradient کمک می‌گیریم */
}

.q-row.right .q-label{
  background:
    radial-gradient(circle at 0% 50%, rgba(0,0,0,.55) 0 18px, rgba(0,0,0,0) 19px),
    linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,0) 35%),
    linear-gradient(90deg, rgba(18,26,30,.95), rgba(46,60,68,.92) 45%, rgba(20,28,34,.95));
}

.q-row.left .q-label{
  background:
    radial-gradient(circle at 100% 50%, rgba(0,0,0,.55) 0 18px, rgba(0,0,0,0) 19px),
    linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,0) 35%),
    linear-gradient(90deg, rgba(18,26,30,.95), rgba(46,60,68,.92) 45%, rgba(20,28,34,.95));
}
.q-label::before{
  box-shadow:
    inset 0 10px 18px rgba(255,255,255,.10),
    inset 0 -12px 18px rgba(0,0,0,.35),
    0 0 14px rgba(120,255,190,.28),
    0 10px 22px rgba(0,0,0,.45);
}
/* ===== Aria Panel (مثل نمونه) ===== */
.aria-panel{
  position:fixed;
  left:22px;
  right:22px;
  bottom:16px;
  margin:0 auto;
  background: rgba(0,0,0,0.55);
  border-radius: 18px;
  padding: 8px 12px;
  backdrop-filter: blur(10px);
  box-shadow: 0 -10px 24px rgba(0,0,0,0.90);
  display:flex;
  align-items:flex-start;
  gap:8px;
  z-index:80;
  pointer-events:none; /* مزاحم کلیک روی شیرها نشه */
}
.aria-panel.aria-flash{ animation: ariaFlash .6s ease-out; }
@keyframes ariaFlash{
  0%{ box-shadow:0 -10px 24px rgba(160,255,130,0.0); transform: translateY(0); }
  50%{ box-shadow:0 -10px 32px rgba(160,255,130,0.55); transform: translateY(-2px); }
  100%{ box-shadow:0 -10px 24px rgba(160,255,130,0.0); transform: translateY(0); }
}
.aria-avatar{
  width:40px; height:40px;
  border-radius:50%;
  overflow:hidden;
  box-shadow: 0 0 10px rgba(0,0,0,0.8);
  flex-shrink:0;
}
.aria-avatar img{
  width:100%; height:100%;
  object-fit:cover;
  display:block;
}
.aria-bubble{
  flex:1;
  background: rgba(0,0,0,0.75);
  border-radius: 18px;
  padding: 8px 10px;
  border: 1px solid rgba(255,255,255,0.08);
  position:relative;
}
.aria-bubble::before{
  content:"";
  position:absolute;
  top: 14px;
  right: -8px;
  border-width: 6px 0 6px 8px;
  border-style: solid;
  border-color: transparent transparent transparent rgba(0,0,0,0.75);
}
.aria-name{
  font-size:11px;
  opacity:.85;
  color:#b8ff7d;
  margin-bottom: 3px;
  font-family:"Nunito", sans-serif;
  font-weight: 900;
}
.aria-text{
  font-family:"Nunito", sans-serif;
  font-size: 22px;
  font-weight: 700;
  line-height: 1.9;
  color:#fff;
}
.aria-text span.good{ color:#b8ff7d; }
.aria-text span.bad{ color:#ffb5b5; }

/* ===== End Modal (امتیاز نهایی + مرحله بعد) ===== */
.end-backdrop{
  position:fixed;
  inset:0;
  background: rgba(0,0,0,0.75);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:95;
}
.end-modal{
  background: rgba(0,0,0,0.90);
  border-radius: 22px;
  padding: 18px 22px;
  width: min(460px, 92vw);
  backdrop-filter: blur(16px);
  box-shadow: 0 22px 40px rgba(0,0,0,1);
  text-align:center;
  color:#fff;
}
.end-title{
  font-family:"Nunito", sans-serif;
  font-weight: 900;
  font-size: 18px;
  margin-bottom: 8px;
}
.end-text{
  font-family:"Nunito", sans-serif;
  font-weight: 700;
  font-size: 14px;
  line-height: 1.9;
  opacity:.98;
  margin-bottom: 16px;
}

/* دکمه‌ها */
.btn{
  border-radius: 999px;
  border:none;
  padding: 10px 18px;
  font-size: 14px;
  cursor:pointer;
  box-shadow: 0 12px 22px rgba(0,0,0,0.9);
  transition: transform .18s ease, box-shadow .18s ease;
  font-family:"Nunito", sans-serif;
  font-weight: 800;
}
.btn:active{ transform: translateY(1px); box-shadow: 0 7px 14px rgba(0,0,0,0.85); }
.btn-primary{
  background: linear-gradient(135deg,#b8ff6a,#46ff8f);
  color:#072313;
}
.btn-ghost{
  background: rgba(255,255,255,0.10);
  color:#fff;
  border: 1px solid rgba(255,255,255,0.16);
}

    /* کمکی: وینیت */


  </style>
</head>
<body>
  <div class="hud">
    <div class="panel">
      <div class="hint">
        <div class="meter">
          <span class="pill"></span>
          
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
          <span class="pill">پرشدن مخزن: <span id="pct">0%</span></span>
          <button class="btn" id="exportBtn">مرحله بعد</button>
        </div>
      </div>

 <!-- سوال‌ها + شیرها (HTML Overlay) -->
<div class="q-wrap" id="qWrap">
  <!-- ردیف 1 -->
  <div class="q-row right" data-q="1">
    <div class="q-label" id="ql1">۱) تفکیک روزانه از مبدا را انجام می‌دهم.</div>
    <div class="valve-ui" data-q="1" title="کلیک برای تغییر">
      <div class="valve-bar" id="vb1"></div>
      <div class="valve-mini" id="hs1">هرگز</div>
    </div>
  </div>

  <div class="q-row left" data-q="4">
    <div class="valve-ui" data-q="4" title="کلیک برای تغییر">
      <div class="valve-bar" id="vb4"></div>
      <div class="valve-mini" id="hs4">هرگز</div>
    </div>
    <div class="q-label" id="ql4">۴) در فعالیت‌های آموزشی تفکیک زباله دانشگاه شرکت می‌کنم.</div>
  </div>

  <!-- ردیف 2 -->
  <div class="q-row right" data-q="2">
    <div class="q-label" id="ql2">۲) انواع زباله‌ها را تفکیک می‌کنم.</div>
    <div class="valve-ui" data-q="2">
      <div class="valve-bar" id="vb2"></div>
      <div class="valve-mini" id="hs2">هرگز</div>
    </div>
  </div>

  <div class="q-row left" data-q="5">
    <div class="valve-ui" data-q="5">
      <div class="valve-bar" id="vb5"></div>
      <div class="valve-mini" id="hs5">هرگز</div>
    </div>
    <div class="q-label" id="ql5">۵) بسته‌بندی کالاهای مصرفی را بازیافت می‌کنم.</div>
  </div>

  <!-- ردیف 3 -->
  <div class="q-row right" data-q="3">
    <div class="q-label" id="ql3">۳) دوستان و خانواده را به تفکیک از مبدا تشویق می‌کنم.</div>
    <div class="valve-ui" data-q="3">
      <div class="valve-bar" id="vb3"></div>
      <div class="valve-mini" id="hs3">هرگز</div>
    </div>
  </div>

  <div class="q-row left" data-q="6">
    <div class="valve-ui" data-q="6">
      <div class="valve-bar" id="vb6"></div>
      <div class="valve-mini" id="hs6">هرگز</div>
    </div>
    <div class="q-label" id="ql6">۶) از لیوان چندبارمصرف استفاده می‌کنم.</div>
  </div>
</div>


      <!-- SVG: لوله‌ها + مخزن مرکزی -->
      <svg viewBox="0 0 1100 680" aria-label="شبکه فاضلاب سبز">
        <defs>

          <!-- Glow سبز -->
          <filter id="greenGlow" x="-50%" y="-50%" width="200%" height="200%">
            <feGaussianBlur stdDeviation="5" result="b"/>
            <feColorMatrix in="b" type="matrix"
              values="0 0 0 0 0
                      0 1 0 0 0.9
                      0 0 0 0 0
                      0 0 0 0.9 0" result="g"/>
            <feMerge>
              <feMergeNode in="g"/>
              <feMergeNode in="SourceGraphic"/>
            </feMerge>
          </filter>

          <!-- گرادیان جریان داخل لوله -->
          <linearGradient id="flowGrad" x1="0" y1="0" x2="1" y2="0">
            <stop offset="0%"  stop-color="rgba(120,255,190,.0)"/>
            <stop offset="40%" stop-color="rgba(120,255,190,.55)"/>
            <stop offset="60%" stop-color="rgba(120,255,190,.95)"/>
            <stop offset="100%" stop-color="rgba(120,255,190,.0)"/>
          </linearGradient>

          <!-- ماسک موج مخزن مرکزی -->
          <clipPath id="tankClip">
            <circle cx="550" cy="420" r="120"/>
          </clipPath>

          <!-- موج (برای liquid fill) -->
          <path id="wavePath" d="" />

          <!-- بافت نویز خیلی سبک -->
          <filter id="softNoise" x="-20%" y="-20%" width="140%" height="140%">
            <feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="1" stitchTiles="stitch" result="n"/>
            <feColorMatrix in="n" type="matrix"
              values="0 0 0 0 0
                      0 0.6 0 0 0
                      0 0 0 0 0
                      0 0 0 0.12 0" result="ng"/>
            <feBlend in="SourceGraphic" in2="ng" mode="overlay"/>
          </filter>
        </defs>
<g id="dynPipesBase" opacity="0.95"></g>
<g id="dynPipesFlow" filter="url(#greenGlow)"></g>
        <!-- لایه پس‌زمینه لوله‌ها (بدون جریان) -->

<filter id="liquidGlow" x="-50%" y="-50%" width="200%" height="200%">
  <feGaussianBlur stdDeviation="8" result="blur"/>
  <feColorMatrix in="blur" type="matrix"
    values="
      0 0 0 0 0
      0 1.3 0 0 0.8
      0 0 0 0 0
      0 0 0 1 0
    " result="neon"/>
  <feMerge>
    <feMergeNode in="neon"/>
    <feMergeNode in="SourceGraphic"/>
  </feMerge>
</filter>
      

        <!-- مخزن مرکزی -->
        <g>
          <!-- بدنه -->
          <circle cx="550" cy="420" r="135" fill="rgba(0,0,0,.35)" stroke="rgba(255,255,255,.18)" stroke-width="10"/>
          <!-- حلقه نور -->
          <circle cx="550" cy="420" r="135" fill="none" stroke="rgba(120,255,190,.25)" stroke-width="8" filter="url(#greenGlow)"/>

          <!-- لایه liquid (داخل clip) -->
          <g clip-path="url(#tankClip)" filter="url(#liquidGlow) url(#softNoise)">
            <rect id="liquidRect" x="410" y="540" width="280" height="280" fill="rgba(120,255,200,0.9)"/>
            <path id="liquidWave" d="" fill="rgba(150,255,220,1)"></path>
          </g>

          <!-- متن درصد -->
          <text x="550" y="428" text-anchor="middle" font-size="44" font-weight="900" fill="#eafff2" style="text-shadow:0 10px 22px rgba(0,0,0,.75)">
            <tspan id="tankText">0%</tspan>
          </text>
          <text x="550" y="462" text-anchor="middle" font-size="12" font-weight="800" fill="rgba(255,255,255,.75)">
            مخزن مرکزی
          </text>
        </g>

      </svg>

      <div class="vignette"></div>
    </div>
  </div>
<!-- پنل آریا -->
<div class="aria-panel" id="ariaPanel">
  <div class="aria-avatar">
    <img src="aria.png" alt="آریا">
  </div>
  <div class="aria-bubble">
    <div class="aria-name">آریا – راهنمای پردیس سبز</div>
    <div class="aria-text" id="ariaText">
      روی <span class="good">شیر</span> هر لوله کلیک کن تا از «هرگز» تا «همیشه» تغییر کند.
      درصد مخزن، امتیاز این بخش است.
    </div>
  </div>
</div>

<!-- مودال پایان -->
<div class="end-backdrop" id="endBackdrop">
  <div class="end-modal">
    <div class="end-title" id="endTitle">نتیجه</div>
    <div class="end-text" id="endText"></div>
    <div style="display:flex; gap:10px; justify-content:center;">
      <button class="btn btn-ghost" id="btnCloseEnd">بستن</button>
      <button class="btn btn-primary" id="btnNextStage">مرحله بعدی</button>
    </div>
  </div>
</div>

<script>
    // ====== Sound Engine (WebAudio) ======

// کلیک کوتاه (tick)
function playValveTick(intensity=0.6){
  if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();

  const t0 = audioCtx.currentTime;

  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  const filter = audioCtx.createBiquadFilter();

  osc.type = "square";
  osc.frequency.setValueAtTime(900, t0);
  osc.frequency.exponentialRampToValueAtTime(500, t0 + 0.03);

  filter.type = "highpass";
  filter.frequency.setValueAtTime(300, t0);

  gain.gain.setValueAtTime(0.0001, t0);
  gain.gain.exponentialRampToValueAtTime(0.12 * intensity, t0 + 0.01);
  gain.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.08);

  osc.connect(filter);
  filter.connect(gain);
  gain.connect(audioCtx.destination);

  osc.start(t0);
  osc.stop(t0 + 0.09);
}

// جریان (loop): نویز + فیلتر + ولوم وابسته به سطح کلی
// ===== Flow Sound (game-like calm) =====
let flowNode = null;
let flowGain = null;
let flowLP = null;
let flowHP = null;
let flowComp = null;

function createPinkNoiseBuffer(ctx, seconds=3){
  const len = Math.floor(ctx.sampleRate * seconds);
  const buffer = ctx.createBuffer(1, len, ctx.sampleRate);
  const data = buffer.getChannelData(0);

  // Pink noise (Voss-McCartney-ish)
  let b0=0, b1=0, b2=0, b3=0, b4=0, b5=0, b6=0;
  for(let i=0;i<len;i++){
    const white = Math.random()*2 - 1;
    b0 = 0.99886*b0 + white*0.0555179;
    b1 = 0.99332*b1 + white*0.0750759;
    b2 = 0.96900*b2 + white*0.1538520;
    b3 = 0.86650*b3 + white*0.3104856;
    b4 = 0.55000*b4 + white*0.5329522;
    b5 = -0.7616*b5 - white*0.0168980;
    const pink = (b0+b1+b2+b3+b4+b5+b6 + white*0.5362) * 0.11;
    b6 = white*0.115926;
    data[i] = pink;
  }
  return buffer;
}

function ensureFlowLoop(){
  if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if(flowNode) return;

  const noise = audioCtx.createBufferSource();
  noise.buffer = createPinkNoiseBuffer(audioCtx, 3.5);
  noise.loop = true;

  // Highpass خیلی ملایم: بمِ اضافی حذف
  const hp = audioCtx.createBiquadFilter();
  hp.type = "highpass";
  hp.frequency.value = 120;
  hp.Q.value = 0.7;

  // Lowpass: صدای نرم و “آب‌طور”
  const lp = audioCtx.createBiquadFilter();
  lp.type = "lowpass";
  lp.frequency.value = 850; // نرم
  lp.Q.value = 0.8;

  // Compressor خیلی سبک: یکنواخت مثل بازی
  const comp = audioCtx.createDynamicsCompressor();
  comp.threshold.value = -26;
  comp.knee.value = 18;
  comp.ratio.value = 2.2;
  comp.attack.value = 0.01;
  comp.release.value = 0.18;

  const gain = audioCtx.createGain();
  gain.gain.value = 0.0; // شروع بی‌صدا

  noise.connect(hp);
  hp.connect(lp);
  lp.connect(comp);
  comp.connect(gain);
  gain.connect(audioCtx.destination);

  noise.start();

  flowNode = noise;
  flowGain = gain;
  flowLP = lp;
  flowHP = hp;
  flowComp = comp;
}
// ===== Fantasy Flow Sound (game-like) =====
let audioCtx = null;

let flow = {
  running:false,
  // nodes
  g:null, comp:null,
  pad1:null, pad2:null,
  padGain:null,
  noiseSrc:null, noiseGain:null, noiseBP:null,
  lfo:null, lfoGain:null,
  pingTimer:null,
};

// helper: create looped noise
function makeNoise(ctx, seconds=2.5){
  const len = Math.floor(ctx.sampleRate * seconds);
  const buf = ctx.createBuffer(1, len, ctx.sampleRate);
  const d = buf.getChannelData(0);
  for(let i=0;i<len;i++) d[i] = (Math.random()*2-1) * 0.6;
  return buf;
}

function ensureFantasyFlow(){
  if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if(flow.running) return;

  // master gain (very low, game ambience)
  const g = audioCtx.createGain();
  g.gain.value = 0.0;

  // compressor to keep it smooth
  const comp = audioCtx.createDynamicsCompressor();
  comp.threshold.value = -30;
  comp.knee.value = 18;
  comp.ratio.value = 2.0;
  comp.attack.value = 0.01;
  comp.release.value = 0.20;

  // --- PAD (magical energy) ---
  const padGain = audioCtx.createGain();
  padGain.gain.value = 0.0;

  const pad1 = audioCtx.createOscillator();
  const pad2 = audioCtx.createOscillator();
  pad1.type = "sine";
  pad2.type = "sine";
  pad1.frequency.value = 180;         // base tone
  pad2.frequency.value = 180;
  pad2.detune.value = 9;              // slight chorus

  // --- NOISE WHOOSH (flow texture) ---
  const noiseSrc = audioCtx.createBufferSource();
  noiseSrc.buffer = makeNoise(audioCtx, 3.2);
  noiseSrc.loop = true;

  const noiseBP = audioCtx.createBiquadFilter();
  noiseBP.type = "bandpass";
  noiseBP.frequency.value = 900;      // airy whoosh band
  noiseBP.Q.value = 0.7;

  const noiseGain = audioCtx.createGain();
  noiseGain.gain.value = 0.0;

  // --- LFO for breathing / movement ---
  const lfo = audioCtx.createOscillator();
  lfo.type = "sine";
  lfo.frequency.value = 0.18;         // slow breathe

  const lfoGain = audioCtx.createGain();
  lfoGain.gain.value = 0.015;         // subtle amplitude movement

  // route LFO to master gain (tremolo feel)
  lfo.connect(lfoGain);
  lfoGain.connect(g.gain);

  // connect graph
  pad1.connect(padGain);
  pad2.connect(padGain);

  noiseSrc.connect(noiseBP);
  noiseBP.connect(noiseGain);

  // mix to compressor -> master
  padGain.connect(comp);
  noiseGain.connect(comp);
  comp.connect(g);
  g.connect(audioCtx.destination);

  // start oscillators
  pad1.start();
  pad2.start();
  noiseSrc.start();
  lfo.start();

  // store
  flow.running = true;
  flow.g = g; flow.comp = comp;
  flow.pad1 = pad1; flow.pad2 = pad2; flow.padGain = padGain;
  flow.noiseSrc = noiseSrc; flow.noiseGain = noiseGain; flow.noiseBP = noiseBP;
  flow.lfo = lfo; flow.lfoGain = lfoGain;

  // optional: tiny magical pings (very low)
  flow.pingTimer = setInterval(()=> {
    // فقط وقتی جریان وجود دارد
    const sum = state.reduce((a,b)=>a+b,0);
    if(sum === 0) return;
    if(Math.random() > 0.22) return;  // گهگاهی

    const t0 = audioCtx.currentTime;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    const filt = audioCtx.createBiquadFilter();

    osc.type = "sine";
    // نوت‌های فانتزی نزدیک هارمونیک‌ها
    const notes = [660, 740, 880, 990, 1320];
    osc.frequency.setValueAtTime(notes[(Math.random()*notes.length)|0], t0);

    filt.type = "highpass";
    filt.frequency.setValueAtTime(500, t0);

    gain.gain.setValueAtTime(0.0001, t0);
    gain.gain.exponentialRampToValueAtTime(0.010, t0 + 0.01);
    gain.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.14);

    osc.connect(filt);
    filt.connect(gain);
    gain.connect(flow.comp); // داخل همین میکس

    osc.start(t0);
    osc.stop(t0 + 0.16);
  }, 260);
}

function setFantasyFlowAmount(norm01){
  ensureFantasyFlow();

  const t0 = audioCtx.currentTime;
  const n = Math.max(0, Math.min(1, norm01));

  // ولوم کلی (خیلی ملایم و بازی‌طور)
  const targetMaster = 0.010 + n * 0.028;   // 0.01..0.038
  flow.g.gain.cancelScheduledValues(t0);
  flow.g.gain.linearRampToValueAtTime(targetMaster, t0 + 0.22);

  // نسبت pad و whoosh
  const padVol = 0.010 + n * 0.020;         // 0.01..0.03
  const whooshVol = 0.004 + n * 0.018;      // 0.004..0.022
  flow.padGain.gain.cancelScheduledValues(t0);
  flow.noiseGain.gain.cancelScheduledValues(t0);
  flow.padGain.gain.linearRampToValueAtTime(padVol, t0 + 0.22);
  flow.noiseGain.gain.linearRampToValueAtTime(whooshVol, t0 + 0.22);

  // رنگ صدا با جریان تغییر کند (جادویی‌تر)
  const baseTone = 170 + n * 80;            // 170..250
  flow.pad1.frequency.cancelScheduledValues(t0);
  flow.pad2.frequency.cancelScheduledValues(t0);
  flow.pad1.frequency.linearRampToValueAtTime(baseTone, t0 + 0.25);
  flow.pad2.frequency.linearRampToValueAtTime(baseTone, t0 + 0.25);

  // bandpass روشن‌تر وقتی بیشتر است
  const bp = 750 + n * 900;                 // 750..1650
  flow.noiseBP.frequency.cancelScheduledValues(t0);
  flow.noiseBP.frequency.linearRampToValueAtTime(bp, t0 + 0.25);

  // تنفس کمی سریع‌تر وقتی بیشتر است
  const lfoHz = 0.12 + n * 0.28;            // 0.12..0.40
  flow.lfo.frequency.cancelScheduledValues(t0);
  flow.lfo.frequency.linearRampToValueAtTime(lfoHz, t0 + 0.35);
}

// این را به‌جای updateFlowSound قبلی استفاده کن
function updateFlowSound(){
  const sum = state.reduce((a,b)=>a+b,0);
  const norm = sum / maxScore;   // 0..1
  setFantasyFlowAmount(norm);
}

// شدت صدای جریان بر اساس مجموع level ها (خیلی ملایم)
function updateFlowSound(){
  ensureFlowLoop();

  const sum = state.reduce((a,b)=>a+b,0); // 0..24
  const norm = sum / maxScore;           // 0..1

  // ولوم بازی‌طور: خیلی کم (پایه خیلی کم + کمی افزایش)
 const base = 0.008;
const extra = 0.020 * norm;      // نهایتاً +0.03
  const targetVol = Math.min(0.040, base + extra); // سقف 0.04

  // فیلتر: هرچی جریان بیشتر، کمی روشن‌تر
  const targetLP = 650 + norm * 650;  // 650..1300

  const t0 = audioCtx.currentTime;

  flowGain.gain.cancelScheduledValues(t0);
  flowGain.gain.linearRampToValueAtTime(targetVol, t0 + 0.25);

  flowLP.frequency.cancelScheduledValues(t0);
  flowLP.frequency.linearRampToValueAtTime(targetLP, t0 + 0.25);
}

  // ===== مدل لیکرت =====
  const likertLabels = ["هرگز","به‌ندرت","گاهی","اغلب","همیشه"];
  const maxScore = 6 * 4;

  // state: q1..q6 each 0..4
  const state = [0,0,0,0,0,0];
const valveUIs = Array.from(document.querySelectorAll(".valve-ui"));
const valveBarsUI = [1,2,3,4,5,6].map(i => document.getElementById("vb"+i));
const valveHints = [1,2,3,4,5,6].map(i => document.getElementById("hs"+i));

const svg = document.querySelector("svg");
const dynBase = document.getElementById("dynPipesBase");
const dynFlow = document.getElementById("dynPipesFlow");
// نقاط ورود به مخزن (در مختصات viewBox)
// راست‌ها از سمت راست وارد، چپ‌ها از سمت چپ وارد
const tankIn = {
  1: {x: 665, y: 345},
  2: {x: 675, y: 385},
  3: {x: 670, y: 425},
  4: {x: 435, y: 345},
  5: {x: 425, y: 385},
  6: {x: 430, y: 425},
};

  // refs
  const pctEl = document.getElementById("pct");
  const tankText = document.getElementById("tankText");
  const tankText2 = document.getElementById("tankText"); // same
  const liquidRect = document.getElementById("liquidRect");
  const liquidWave = document.getElementById("liquidWave");

  let flows = [1,2,3,4,5,6].map(i => document.getElementById("flow"+i));

  const valveBars = [1,2,3,4,5,6].map(i => document.getElementById("v"+i));
  const valveStates = [1,2,3,4,5,6].map(i => document.getElementById("s"+i));

  // ===== انیمیشن جریان داخل لوله (dashoffset) =====
  let t = 0;
  function animatePipes(){
    t += 1;
    for(let i=0;i<6;i++){
      // سرعت جریان متناسب با درجه
      const level = state[i]; // 0..4
      const speed = 0.6 + level * 0.9; // 0.6..4.2
      flows[i].setAttribute("stroke-dashoffset", String(-t * speed));
      // شدت دیده شدن جریان
      flows[i].style.opacity = (level === 0) ? 0.0 : (0.25 + level*0.18); // 0.43..0.97
    }
    requestAnimationFrame(animatePipes);
  }
  requestAnimationFrame(animatePipes);
function clientToSvgPoint(clientX, clientY){
  const pt = svg.createSVGPoint();
  pt.x = clientX; pt.y = clientY;
  const ctm = svg.getScreenCTM().inverse();
  const p = pt.matrixTransform(ctm);
  return {x:p.x, y:p.y};
}

function getValveCenter(q){
  const el = document.querySelector(`.valve-ui[data-q="${q}"]`);
  const r = el.getBoundingClientRect();
  const cx = r.left + r.width/2;
  const cy = r.top + r.height/2;
  return clientToSvgPoint(cx, cy);
}
function getBehindLabelStart(q){
  // q: 1..6
  const row = document.querySelector(`.q-row[data-q="${q}"]`);
  const label = row.querySelector(".q-label");
  const r = label.getBoundingClientRect();

  const isRight = (q <= 3); // ستون راست یا چپ
  const inset = 18;         // چند px داخل باکس برود (برای حس "پشت باکس")
  const y = r.top + r.height * 0.5;

  // برای ستون راست: شیر سمت چپ باکس است، پس شروع از لبه چپ باکس
  // برای ستون چپ: شیر سمت راست باکس است، پس شروع از لبه راست باکس
  const x = isRight ? (r.left + inset) : (r.right - inset);

  return clientToSvgPoint(x, y);
}
function getOuterBoxStart(q){
  const row = document.querySelector(`.q-row[data-q="${q}"]`);
  const label = row.querySelector(".q-label");
  const r = label.getBoundingClientRect();

  const isRight = (q <= 3);

  const y = r.top + r.height * 0.5;

  // شروع از لبه بیرونی (دور از مخزن)
  const x = isRight ? r.right : r.left;

  return { dom: {x, y}, svg: clientToSvgPoint(x, y), rect: r };
}

// مسیر نرم + کنترل تداخل: لوله‌ها اول عمودی می‌آیند پایین تا زیر باکس‌ها، بعد به مخزن
function buildPipeD(q){
  const isRight = (q <= 3);
  const idx = isRight ? (q-1) : (q-4); // 0..2 برای هر ستون

  const startInfo = getOuterBoxStart(q);
  const start = startInfo.svg;

  const end = tankIn[q];

  // یک X بیرونی‌تر که لوله‌ها کنار باکس‌ها پایین بروند (Lane مجزا برای هر ردیف)
  const outerOffset = 60;           // فاصله اولیه از لبه باکس
  const laneGap = 34;               // فاصله بین لاین‌ها برای جلوگیری از تداخل
  const laneX = isRight
    ? (start.x + outerOffset + idx*laneGap)   // ستون راست: برو بیرون‌تر (به راست)
    : (start.x - outerOffset - idx*laneGap);  // ستون چپ: برو بیرون‌تر (به چپ)

  // تا پایین‌تر از کل باکس‌ها بیاید (هر ردیف کمی پایین‌تر تا طول مسیر بیشتر شود)
  const wrap = document.getElementById("qWrap").getBoundingClientRect();
  const baseUnderY = clientToSvgPoint(0, wrap.bottom + 30).y;
  const underY = baseUnderY + idx*75; // ردیف 1 کمتر، ردیف 3 بیشتر (زیباتر و طولانی‌تر)

  // یک نقطه افقی قبل از ورود به مخزن (تا قوس قشنگ شود)
  const preTankX = isRight ? (end.x + 90) : (end.x - 90);

  const r = 40; // نرمی قوس‌ها

  // مسیر:
  // 1) از لبه بیرونی باکس به laneX (کوتاه)
  // 2) عمودی پایین تا underY (کنار باکس‌ها)
  // 3) افقی به سمت preTankX
  // 4) قوس به سمت end
  return `
    M ${start.x} ${start.y}

    C ${start.x} ${start.y}, ${laneX} ${start.y}, ${laneX} ${start.y}

    C ${laneX} ${start.y + r}, ${laneX} ${underY - r}, ${laneX} ${underY}

    C ${laneX} ${underY}, ${preTankX} ${underY}, ${preTankX} ${underY}

    C ${preTankX} ${underY}, ${end.x} ${end.y}, ${end.x} ${end.y}
  `.replace(/\s+/g,' ').trim();
}


function rebuildPipes(){
  dynBase.innerHTML = "";
  dynFlow.innerHTML = "";

  for(let q=1;q<=6;q++){
    const d = buildPipeD(q);

    const base = document.createElementNS("http://www.w3.org/2000/svg","path");
    base.setAttribute("d", d);
    base.setAttribute("fill","none");
    base.setAttribute("stroke","rgba(255,255,255,.18)");
    base.setAttribute("stroke-width","22");
    base.setAttribute("stroke-linecap","round");
    dynBase.appendChild(base);

    const flow = document.createElementNS("http://www.w3.org/2000/svg","path");
    flow.setAttribute("id", "flow"+q);
    flow.setAttribute("d", d);
    flow.setAttribute("fill","none");
    flow.setAttribute("stroke","url(#flowGrad)");
    flow.setAttribute("stroke-width","10");
    flow.setAttribute("stroke-linecap","round");
    flow.setAttribute("stroke-dasharray","14 26");
    flow.setAttribute("stroke-dashoffset","0");
    flow.style.opacity = "0.0";
    dynFlow.appendChild(flow);
  }

  // آپدیت رفرنس flows بعد از ساخت مجدد
  for(let i=1;i<=6;i++){
    flows[i-1] = document.getElementById("flow"+i);
  }
}
rebuildPipes();

window.addEventListener("resize", rebuildPipes);
window.addEventListener("load", rebuildPipes);

  // ===== موج مخزن مرکزی =====
  // درصد پرشدن (0..100)
  let targetPct = 0;
  let currentPct = 0;

  function updateTankTarget(){
    const sum = state.reduce((a,b)=>a+b,0);
    targetPct = Math.round((sum / maxScore) * 100);

    pctEl.textContent = targetPct + "%";
  }

  // ساخت موج SVG ساده
  function buildWavePath(yBase, amp, phase){
    const x0 = 410, width = 280;
    const y = yBase;
    const points = 8; // تعداد موج‌ها
    let d = `M ${x0} ${y}`;
    const step = width / points;

    for(let i=0;i<=points;i++){
      const x = x0 + i*step;
      const yy = y + Math.sin((i*1.2) + phase) * amp;
      d += ` L ${x} ${yy}`;
    }
    // بستن به پایین
    d += ` L ${x0+width} 820 L ${x0} 820 Z`;
    return d;
  }

  function animateTank(){
    // easing نرم
    currentPct += (targetPct - currentPct) * 0.04;

    const pct = Math.max(0, Math.min(100, currentPct));
    const tankTop = 420 - 120;  // y top of circle
    const tankBottom = 420 + 120;

    // y سطح مایع
    const yLevel = tankBottom - (pct/100) * (tankBottom - tankTop);
liquidWave.style.filter =
  "drop-shadow(0 0 8px rgba(120,255,200,0.9)) drop-shadow(0 0 18px rgba(120,255,200,0.6))";

    // مستطیل پایه
    liquidRect.setAttribute("y", yLevel);

    // موج
    const amp = 6 + (Math.sin(Date.now()/700)*2);
    const phase = Date.now()/450;
    liquidWave.setAttribute("d", buildWavePath(yLevel, amp, phase));

    const txt = Math.round(pct) + "%";
    tankText.textContent = txt;
const glowStrength = 6 + pct * 0.12;
liquidWave.style.filter =
  `drop-shadow(0 0 ${glowStrength}px rgba(120,255,200,0.95))`;

    requestAnimationFrame(animateTank);
  }
  requestAnimationFrame(animateTank);

  // ===== شیر ۵ حالته =====
  function setLevel(qIndex, level){
  state[qIndex] = level;

  // زاویه
  const deg = -70 + level * 35; // -70..70

  // شیر HTML
  valveBarsUI[qIndex].style.transform = `rotate(${deg}deg)`;
  valveHints[qIndex].textContent = likertLabels[level];

  // (اختیاری) اگر هنوز valveBars/valveStates مربوط به SVG را داری، حذف/کامنت کن
  // valveBars[qIndex].setAttribute("transform", `rotate(${deg})`);
  // valveStates[qIndex].textContent = likertLabels[level];

  updateTankTarget();
  localStorage.setItem("performance_q"+(qIndex+1), String(level));
}

  // کلیک روی شیر: 0->1->2->3->4->0
document.querySelectorAll(".valve-ui").forEach(el=>{
  el.addEventListener("click", ()=>{
    const q = Number(el.getAttribute("data-q")) - 1;
    const next = (state[q] + 1) % 5;
    setLevel(q, next);
    setAria(`درجه این لوله شد: <span class="good">${likertLabels[next]}</span> — درصد مخزن در حال به‌روزرسانی است.`);
playValveTick(0.45);

  });




    // اسکرول: بالا زیاد، پایین کم (اختیاری و کاربردی روی دسکتاپ)
    el.addEventListener("wheel", (e)=>{
      e.preventDefault();
      const q = Number(el.getAttribute("data-q")) - 1;
      const delta = Math.sign(e.deltaY);
      let next = state[q] + (delta < 0 ? 1 : -1);
      next = Math.max(0, Math.min(4, next));
      setLevel(q, next);
playValveTick(0.7);

    }, {passive:false});
  });

  // init
  for(let i=0;i<6;i++) setLevel(i, 0);

window.addEventListener("pointerdown", ()=>{
  if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  audioCtx.resume?.();
}, {once:true});
// ===== Aria UI =====
const ariaPanel = document.getElementById("ariaPanel");
const ariaTextEl = document.getElementById("ariaText");

function animateAria(){
  ariaPanel.classList.remove("aria-flash");
  void ariaPanel.offsetWidth;
  ariaPanel.classList.add("aria-flash");
}

function setAria(html){
  ariaTextEl.innerHTML = html;
  animateAria();
}

// پیام اولیه
setAria(` <span class="good"></span> روی شیر هر لوله کلیک کن تا درجه‌اش از «هرگز» تا «همیشه» تغییر کند`);

// ===== End Modal =====
const endBackdrop = document.getElementById("endBackdrop");
const endTitle = document.getElementById("endTitle");
const endText = document.getElementById("endText");
const btnCloseEnd = document.getElementById("btnCloseEnd");
const btnNextStage = document.getElementById("btnNextStage");

function openEndModal(){
  const raw = state.reduce((a,b)=>a+b,0);        // 0..24
  const pct = Math.round((raw / maxScore) * 100);// 0..100

  endTitle.textContent = "پایان این بخش ✅";
  endText.innerHTML =
    `امتیاز نهایی: <b>${raw}</b> از <b>${maxScore}</b>` +
    `<br>درصد پرشدن مخزن: <b>${pct}%</b>` +
    `<br>خروجی ذخیره شد ✅`;

  endBackdrop.style.display = "flex";
}

function closeEndModal(){
  endBackdrop.style.display = "none";
}

btnCloseEnd.addEventListener("click", closeEndModal);

// لینک مرحله بعد را خودت تنظیم کن
btnNextStage.addEventListener("click", ()=>{
  window.location.href = "stage1.html";
});

  // خروجی کلی
document.getElementById("exportBtn").addEventListener("click", ()=>{
  const raw = state.reduce((a,b)=>a+b,0);
  const pct = Math.round((raw / maxScore) * 100);

  const out = {
    performance: {
      q1: state[0],
      q2: state[1],
      q3: state[2],
      q4: state[3],
      q5: state[4],
      q6: state[5],
    },
    total_score: raw,          // ✅ امتیاز نهایی
    max_score: maxScore,       // ✅ 24
    tank_fill_pct: pct         // (اختیاری) درصد
  };

  localStorage.setItem("performance_block", JSON.stringify(out));

  setAria(`<span class="good">عالی!</span> امتیاز نهایی تو <b>${raw}</b> از <b>${maxScore}</b> ذخیره شد.`);
  openEndModal();
  async function sendToSheet(){
  const report = buildFinalReport();

  const res = await fetch("WEB_APP_URL", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(report)
  });

  // ذخیره محلی هم برای اطمینان
  localStorage.setItem("final_report", JSON.stringify(report));
}
await sendToSheet();
window.location.href = "thanks.html"; // یا صفحه پایان

});


</script>
</body>
</html>
